---
import "@fontsource-variable/inter";
import Footer from "~/components/footer.astro";
import Header from "~/components/header.astro";
import "~/styles/index.css";

type Props = {
  title: string;
  description?: string;
  lang: string;
  structuredData?: object | object[];
};

const {
  title,
  description = "AARGB",
  lang,
  structuredData,
} = Astro.props satisfies Props;

const { generator, site } = Astro;
const image = new URL("images/LOGO.webp", site);

// SEO: Build canonical URL and alternate language URLs
const LOCALES = ["zh", "en", "ru", "tr"] as const;
const DEFAULT_LOCALE = "en";

// Get current path without locale prefix
const pathname = Astro.url.pathname;
const segments = pathname.split("/").filter(Boolean);
const firstSegment = segments[0];
const isLocaleInPath = LOCALES.includes(firstSegment as any);
const pathWithoutLocale = isLocaleInPath 
  ? "/" + segments.slice(1).join("/")
  : pathname;

// Normalize path (remove trailing slash unless root)
const normalizedPath = pathWithoutLocale === "/" 
  ? "/" 
  : pathWithoutLocale.replace(/\/$/, "") || "/";

// Build canonical URL (always use the current language version)
const canonicalURL = lang === DEFAULT_LOCALE
  ? new URL(normalizedPath, site)
  : new URL(`/${lang}${normalizedPath}`, site);

// Build alternate URLs for all languages
const alternateURLs = LOCALES.map(locale => ({
  lang: locale,
  url: locale === DEFAULT_LOCALE
    ? new URL(normalizedPath, site).href
    : new URL(`/${locale}${normalizedPath}`, site).href
}));
---

<!doctype html>
<html lang={lang} class="h-full motion-safe:scroll-smooth" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" href="/favicon.png" type="image/png" sizes="64x64" />
    <link
      rel="preload"
      as="image"
      href="/images/LOGO.webp"
      type="image/webp"
      fetchpriority="high"
    />
    <meta name="generator" content={generator} />

    <title>{title}</title>
    <meta name="description" content={description} />

    <!-- SEO: Canonical URL -->
    <link rel="canonical" href={canonicalURL} />

    <!-- SEO: Alternate language versions (hreflang) -->
    {alternateURLs.map(({ lang: hreflang, url }) => (
      <link rel="alternate" hreflang={hreflang} href={url} />
    ))}
    <link rel="alternate" hreflang="x-default" href={new URL(normalizedPath, site)} />

    <!-- social media -->
    <meta property="og:title" content={title} />
    <meta property="og:type" content="website" />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={image} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:locale" content={lang === "zh" ? "zh_CN" : lang === "ru" ? "ru_RU" : lang === "tr" ? "tr_TR" : "en_US"} />
    {alternateURLs.filter(alt => alt.lang !== lang).map(({ lang: altLang }) => (
      <meta property="og:locale:alternate" content={altLang === "zh" ? "zh_CN" : altLang === "ru" ? "ru_RU" : altLang === "tr" ? "tr_TR" : "en_US"} />
    ))}
    <meta name="twitter:card" content="summary_large_image" />

    <!-- Structured Data (JSON-LD) -->
    {structuredData && (
      <script type="application/ld+json" set:html={JSON.stringify(Array.isArray(structuredData) ? structuredData : [structuredData])} />
    )}

    <!-- force dark theme (remove light theme entirely) -->
    <script is:inline>
      document.documentElement.dataset.theme = "dark";
      try {
        localStorage.removeItem("theme");
      } catch {}
    </script>

    <!-- persist language + redirect non-prefixed routes to preferred locale -->
    <script is:inline>
      const LOCALES = ["zh", "en", "ru", "tr"];
      const DEFAULT_LOCALE = "en";

      const pathname = window.location.pathname;
      const segments = pathname.split("/").filter(Boolean);
      const first = segments[0];

      const currentLang = document.documentElement.lang;
      // Only persist when the URL explicitly includes a locale prefix
      // (e.g. "/zh/...", "/ru/..."). This prevents first-time visits to
      // non-prefixed routes (like "/") from "locking" the preference to
      // the default locale.
      if (first && LOCALES.includes(first) && first === currentLang) {
        try {
          localStorage.setItem("lang", currentLang);
        } catch {}
      }

      const detectBrowserLocale = () => {
        const langs = Array.isArray(navigator.languages) && navigator.languages.length
          ? navigator.languages
          : [navigator.language].filter(Boolean);

        for (const raw of langs) {
          const l = String(raw).toLowerCase();
          if (l.startsWith("zh")) return "zh";
          if (l.startsWith("ru")) return "ru";
          if (l.startsWith("tr")) return "tr";
          if (l.startsWith("en")) return "en";
        }
        return DEFAULT_LOCALE;
      };

      let preferred = null;
      try {
        preferred = localStorage.getItem("lang");
      } catch {}
      if (!preferred || !LOCALES.includes(preferred)) {
        preferred = detectBrowserLocale();
        // Only persist non-default; default behavior stays English.
        if (preferred && preferred !== DEFAULT_LOCALE) {
          try {
            localStorage.setItem("lang", preferred);
          } catch {}
        }
      }

      if (preferred && LOCALES.includes(preferred) && preferred !== DEFAULT_LOCALE) {
        // Only redirect when URL has no locale prefix (e.g. /products/)
        if (!first || !LOCALES.includes(first)) {
          const normalized = pathname.startsWith("/") ? pathname : `/${pathname}`;
          const target = `/${preferred}${normalized}`;
          if (target !== pathname) {
            window.location.replace(
              `${target}${window.location.search}${window.location.hash}`,
            );
          }
        }
      }
    </script>
  </head>
  <body
    class="h-full min-h-screen overflow-x-hidden bg-default text-default text-base"
  >
    <div class="site-bg" aria-hidden="true"></div>
    <div class="relative z-10 flex min-h-screen flex-col">
      <Header />
      <main class="flex-1 px-4 pt-16 pb-32 sm:px-8">
        <div class="mx-auto w-full max-w-7xl">
          <slot />
        </div>
      </main>
      <Footer />
    </div>
  </body>
</html>


